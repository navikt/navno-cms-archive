# Stage 1: Install Chromium
FROM debian:bookworm-slim AS chromium-installer
RUN apt-get update && \
    apt-get install -y --no-install-recommends chromium chromium-driver && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Stage 2: Final image
FROM europe-north1-docker.pkg.dev/cgr-nav/pull-through/nav.no/node:22

# Copy Chromium and dependencies from installer stage
COPY --from=chromium-installer /usr/bin/chromium /usr/bin/chromium
COPY --from=chromium-installer /usr/lib/chromium /usr/lib/chromium
COPY --from=chromium-installer /usr/lib/x86_64-linux-gnu /usr/lib/x86_64-linux-gnu

WORKDIR /app/legacy-archive/server

ENV NODE_ENV=production
ENV PUPPETEER_CACHE_DIR=/app/.puppeteer-cache
ENV PUPPETEER_TMP_DIR=/tmp/.puppeteer
ENV XDG_CONFIG_HOME=/tmp/.chromium
ENV XDG_CACHE_HOME=/tmp/.chromium
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium

COPY node_modules /app/node_modules/
COPY .cache/puppeteer /app/.puppeteer-cache/
COPY legacy-archive/server/dist  /app/legacy-archive/server/dist/
COPY legacy-archive/server/package.json /app/legacy-archive/server/

EXPOSE 3399
CMD ["npm", "run", "start"]
